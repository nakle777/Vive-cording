<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>바이브코딩 동의서 & 참가자 조회</title>
  <meta name="description" content="개인정보/생성형 AI 활용 동의 후 참가자 정보를 조회합니다.">
  <style>
    :root{ --bg:#f7f7fb; --card:#fff; --ink:#111827; --muted:#6b7280; --line:#e5e7eb; --brand:#111827; --ok:#065f46; --okbg:#ecfdf5; --warn:#7c2d12; --warnbg:#fff7ed; }
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple SD Gothic Neo","Noto Sans KR","Malgun Gothic",sans-serif;margin:0;background:var(--bg);color:var(--ink);line-height:1.55}
    .wrap{max-width:960px;margin:6vh auto;padding:0 16px}
    .card{background:var(--card);border-radius:16px;box-shadow:0 8px 30px rgba(0,0,0,.06);padding:24px}
    h1{font-size:22px;margin:0 0 8px} h2{font-size:18px;margin:24px 0 8px} h3{font-size:15px;margin:18px 0 8px}
    p{margin:8px 0} .muted{color:var(--muted);font-size:12px}
    .grid{display:grid;gap:16px;grid-template-columns:1fr} @media(min-width:900px){ .grid{grid-template-columns:1fr 1fr} }
    .section{border:1px solid var(--line);border-radius:12px;padding:16px}
    .scroll{max-height:240px;overflow:auto;border:1px solid var(--line);border-radius:10px;padding:12px;background:#fafafa}
    label{font-size:14px} input[type="text"], input[type="tel"]{width:100%;padding:12px 14px;border:1px solid #e2e2ea;border-radius:10px;outline:none}
    input:focus{border-color:#6366f1;box-shadow:0 0 0 3px rgba(99,102,241,.15)}
    input[type="checkbox"]{transform:scale(1.15);margin-right:8px}
    .row{display:flex;gap:8px;align-items:center} .row>*{flex:1}
    .btn{display:inline-block;padding:12px 14px;border-radius:10px;border:0;background:var(--brand);color:#fff;cursor:pointer;font-weight:600}
    .btn[disabled]{opacity:.5;cursor:not-allowed} .btn-ghost{background:#f3f4f6;color:#111827;border:1px solid var(--line)}
    .msg{margin-top:12px;font-size:14px} .ok{color:var(--ok);background:var(--okbg);padding:10px;border-radius:10px}
    .warn{color:var(--warn);background:var(--warnbg);padding:10px;border-radius:10px}
    .hide{display:none}
    .hint{font-size:12px;color:var(--muted)}
    .pill{font-size:12px;background:#eef2ff;color:#3730a3;border-radius:999px;padding:4px 8px;margin-left:6px}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- STEP 1: CONSENT -->
    <div class="card" id="step-consent">
      <h1>동의서 확인</h1>
      <p class="muted">아래 두 항목에 동의 후 조회 단계로 넘어갑니다. (필수)</p>

      <div class="grid">
        <div class="section">
          <h2>1) 개인정보 수집·이용 동의서 <span class="pill">필수</span></h2>
          <div class="scroll">
            <h3>수집 항목</h3><ul><li>참가자 이름, 보호자 성함 또는 연락처(뒷 4자리)</li></ul>
            <h3>수집·이용 목적</h3><ul><li>본인 확인 및 참가자별 안내 링크 조회/제공</li></ul>
            <h3>보유·이용 기간</h3><ul><li>수업 종료 후 최대 1년 또는 동의 철회 시 즉시 파기</li></ul>
            <h3>제3자 제공/처리 위탁</h3><ul><li>Google(스프레드시트/Apps Script), GitHub Pages 인프라 이용</li></ul>
            <h3>동의 거부 권리</h3><ul><li>동의를 거부할 수 있으나, 거부 시 온라인 조회 서비스 이용이 제한될 수 있습니다.</li></ul>
            <h3>문의</h3><ul><li>담당자: 바이브코딩 운영팀 / 연락처: (관리자가 기입)</li></ul>
          </div>
          <div class="row" style="margin-top:8px;align-items:center">
            <div style="flex:0 0 auto"><input type="checkbox" id="agree-privacy"></div>
            <label for="agree-privacy"><b>개인정보 수집·이용에 동의합니다.</b></label>
          </div>
        </div>

        <div class="section">
          <h2>2) 생성형 AI 활용 동의서 <span class="pill">필수</span></h2>
          <div class="scroll">
            <h3>활용 범위</h3><ul><li>수업 자료 제작, 아이디어 도출, 요약/정리 등 학습 보조 목적</li></ul>
            <h3>주의 사항</h3><ul><li>AI 출력물은 오류가 있을 수 있어 교사 검수 후 활용</li></ul>
            <h3>동의 철회</h3><ul><li>언제든지 동의 철회 가능(이후 활용 중단)</li></ul>
          </div>
          <div class="row" style="margin-top:8px;align-items:center">
            <div style="flex:0 0 auto"><input type="checkbox" id="agree-ai"></div>
            <label for="agree-ai"><b>생성형 AI 활용에 동의합니다.</b></label>
          </div>
        </div>
      </div>

      <h3 style="margin-top:16px">서명 정보</h3>
      <div class="row">
        <div><label>학생(참가자) 이름</label><input id="sign-student" placeholder="예: 홍길동"></div>
        <div><label>학부모(보호자) 성함</label><input id="sign-parent" placeholder="예: 김OO"></div>
      </div>
      <p class="hint">*서명 정보는 다음 단계 입력란에도 자동 채워집니다.</p>

      <div class="row" style="margin-top:8px">
        <button class="btn" id="btn-accept" disabled>동의하고 조회 단계로 진행</button>
        <button class="btn btn-ghost" id="btn-print" type="button">인쇄/저장(PDF)</button>
      </div>
      <div id="consent-msg" class="msg"></div>
    </div>

    <!-- STEP 2: LOOKUP -->
    <div class="card hide" id="step-lookup">
      <h1>참가자 조회</h1>
      <p class="muted">필요 항목을 입력하고 [조회]를 눌러주세요. <b>보호자 성함 또는 전화번호 뒷 4자리</b> 중 하나로 조회 가능합니다.</p>

      <div class="row">
        <div><label>참가자 이름</label><input id="pname" type="text" placeholder="예: 홍길동" autocomplete="off"></div>
        <div><label>보호자 성함</label><input id="gname" type="text" placeholder="예: 김OO" autocomplete="off"></div>
      </div>
      <div class="row">
        <div><label>전화번호 뒷 4자리 (선택)</label><input id="phone4" type="tel" inputmode="numeric" pattern="[0-9]{4}" maxlength="4" placeholder="예: 1234"></div>
        <div style="flex:0.5"></div>
      </div>

      <button id="go" class="btn" style="margin-top:12px">조회</button>
      <div id="msg" class="msg"></div>

      <div id="result" class="section" style="display:none;margin-top:12px">
        <div><b>조회 결과</b></div>
        <div class="row" style="margin-top:8px">
          <input id="link" type="text" readonly>
          <a id="open" class="btn btn-ghost" href="#" target="_blank" style="text-align:center">새 탭에서 열기</a>
        </div>
        <p class="hint">자동 이동하지 않습니다. 필요 시 링크를 열거나 복사하세요.</p>
      </div>
    </div>

    <p class="muted" style="margin-top:12px">*본 템플릿은 예시이며, 실제 운영 시 기관 정책과 관련 법령에 맞춰 문구를 조정하세요.</p>
  </div>

<script>
// ================= 설정값 =================
// 1) 조회용 GAS (DB 스크립트)
const GAS_URL = "https://script.google.com/macros/s/AKfycbzlbKFDtaNha3MMOTFz7Gi1RC7Id-A2ktOIMB_CEJywNGqBNInxLj1FKdWTUhxvYLNp7A/exec"; // /exec
// 2) 동의 로그용 GAS (백엔드 스크립트)
const CONSENT_LOG_URL = "https://script.google.com/macros/s/AKfycbx3-CFFsZ1iXENUOBeyXDc4oTKKqoqzXhjGthUFkarh6wlQPvU1NRm4pnqnUCvagn_8/exec"; // /exec
// 3) (선택) 토큰: 양쪽 스크립트에 토큰이 있을 경우 여기에 동일 값 설정
const ACCESS_TOKEN = "";
// ==========================================

// 버튼 활성화
function consentReady(){
  const a = document.getElementById('agree-privacy').checked;
  const b = document.getElementById('agree-ai').checked;
  const s = document.getElementById('sign-student').value.trim();
  const p = document.getElementById('sign-parent').value.trim();
  document.getElementById('btn-accept').disabled = !(a && b && s && p);
}
['agree-privacy','agree-ai','sign-student','sign-parent'].forEach(id => {
  document.getElementById(id).addEventListener('input', consentReady);
  document.getElementById(id).addEventListener('change', consentReady);
});

document.getElementById('btn-print').addEventListener('click', () => window.print());

// 동의 로그 저장: Beacon -> FormData(no-cors) -> Pixel GET
async function logConsent(student, parent){
  const payload = { student, parent, privacy:true, ai:true, ts:new Date().toISOString(), ua:navigator.userAgent, referer:location.href };

  // 1) sendBeacon
  try{
    if (navigator.sendBeacon) {
      const blob = new Blob([JSON.stringify(payload)], { type: 'application/json' });
      const beaconUrl = CONSENT_LOG_URL + (ACCESS_TOKEN ? ('?token=' + encodeURIComponent(ACCESS_TOKEN)) : '');
      const ok = navigator.sendBeacon(beaconUrl, blob);
      if (ok) return true;
    }
  }catch(_){}

  // 2) FormData (no-cors)
  try{
    const url = new URL(CONSENT_LOG_URL);
    if (ACCESS_TOKEN) url.searchParams.set("token", ACCESS_TOKEN);
    const fd = new FormData();
    fd.append('payload', JSON.stringify(payload));
    await fetch(url.toString(), { method:'POST', body: fd, mode: 'no-cors' });
    return true;
  }catch(_){}

  // 3) Pixel GET
  try{
    const pixelUrl = new URL(CONSENT_LOG_URL);
    if (ACCESS_TOKEN) pixelUrl.searchParams.set("token", ACCESS_TOKEN);
    pixelUrl.searchParams.set("log", "1");
    pixelUrl.searchParams.set("payload", encodeURIComponent(JSON.stringify(payload)));
    const img = new Image();
    img.src = pixelUrl.toString();
    return true;
  }catch(_){
    return false;
  }
}

document.getElementById('btn-accept').addEventListener('click', async () => {
  const msg = document.getElementById('consent-msg');
  msg.className = 'msg'; msg.textContent = '';
  const student = document.getElementById('sign-student').value.trim();
  const parent  = document.getElementById('sign-parent').value.trim();

  const ok = await logConsent(student, parent);
  if (!ok){
    msg.className = 'msg warn';
    msg.textContent = '동의 저장 통신에 문제가 있습니다. (네트워크 또는 웹앱 설정 점검)';
    return;
  }
  document.getElementById('pname').value = student;
  document.getElementById('gname').value = parent;
  document.getElementById('step-consent').classList.add('hide');
  document.getElementById('step-lookup').classList.remove('hide');
  window.scrollTo({top:0, behavior:'smooth'});
});

// 조회(GET): 이름 + (보호자 성함 또는 phone4)
async function lookup(pname, gname, phone4){
  const url = new URL(GAS_URL);
  url.searchParams.set("pname", pname.trim());
  if (phone4) url.searchParams.set("phone4", phone4.trim());
  else url.searchParams.set("gname", gname.trim());
  if (ACCESS_TOKEN) url.searchParams.set("token", ACCESS_TOKEN);
  const res = await fetch(url.toString(), { method: 'GET' });
  if (!res.ok) throw new Error('서버 응답 오류: ' + res.status);
  return await res.json();
}

document.getElementById('go').addEventListener('click', async () => {
  const pname = document.getElementById('pname').value;
  const gname = document.getElementById('gname').value;
  const phone4 = document.getElementById('phone4').value.replace(/\D+/g,'');
  const msg = document.getElementById('msg');
  const result = document.getElementById('result');
  result.style.display = 'none';
  msg.className = 'msg'; msg.textContent = '';

  if (!pname){ msg.className='msg warn'; msg.textContent='참가자 이름을 입력해 주세요.'; return; }
  if (!gname && !phone4){ msg.className='msg warn'; msg.textContent='보호자 성함 또는 전화번호 뒷 4자리 중 하나를 입력해 주세요.'; return; }
  if (phone4 && phone4.length !== 4){ msg.className='msg warn'; msg.textContent='전화번호는 뒷 4자리만 입력해 주세요.'; return; }

  try{
    const r = await lookup(pname, gname, phone4);
    if (!r || r.ok !== true){ msg.className='msg warn'; msg.textContent=(r && r.error) ? r.error : '일치하는 항목이 없습니다.'; return; }
    if (!r.link){ msg.className='msg warn'; msg.textContent='일치 항목은 있으나 link가 비어 있습니다.'; return; }
    document.getElementById('link').value = r.link;
    document.getElementById('open').href = r.link;
    result.style.display = 'block';
    msg.className = 'msg ok'; msg.textContent = '조회 완료. 아래 링크를 확인하세요.';
  }catch(e){
    msg.className='msg warn'; msg.textContent = e.message;
  }
});
</script>
</body>
</html>
